<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据记录 - 科学分组和数据记录</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .nav-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .nav-link {
            display: inline-block;
            margin: 0 15px;
            padding: 8px 16px;
            text-decoration: none;
            color: #666;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .nav-link:hover {
            background-color: #f8f9fa;
        }

        .nav-link.active {
            color: #007bff;
            font-weight: bold;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background-color: #007bff;
        }
        
        .btn-success {
            background-color: #28a745;
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .btn-secondary {
            background-color: #6c757d;
        }
        
        .btn-danger {
            background-color: #dc3545;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: #007bff;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-warning {
            background-color: #ff9800;
            color: white;
        }

        .btn-warning:hover {
            background-color: #e68900;
        }

        .group-info-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .group-info-table th, .group-info-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .group-info-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        .data-input-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
            display: block;
        }

        .data-input-table th, .data-input-table td {
            border: 1px solid #ddd;
            padding: 5px;
            text-align: center;
            min-width: 80px;
        }

        .data-input-table th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
            font-weight: bold;
        }

        .chart-container {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: white;
            overflow: visible;
        }

        .error-message {
            color: #dc3545;
            margin-top: 5px;
            font-size: 14px;
        }

        .success-message {
            color: #28a745;
            margin-top: 5px;
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-col {
            flex: 1;
        }

        .scrollable-table {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .scrollable-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .scrollable-table th {
            position: sticky;
            top: 0;
            background-color: #f2f2f2;
            z-index: 1;
        }

        .chart-image {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <!-- 密码验证界面 -->
    <div id="password-container" class="container" style="max-width: 400px; margin-top: 100px;">
        <h2 style="text-align: center; color: #333; margin-bottom: 30px;">访问验证</h2>
        <div class="form-group">
            <label for="access-password">请输入访问密码：</label>
            <input type="password" id="access-password" placeholder="输入密码" style="width: 100%; padding: 10px; margin-bottom: 15px;">
            <button onclick="verifyPassword()" id="verify-btn" style="width: 100%; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">验证</button>
        </div>
        <div id="password-error" style="color: #dc3545; text-align: center; margin-top: 10px; display: none;">密码错误，请重试</div>
    </div>

    <!-- 实际数据记录内容 -->
    <div id="main-content" style="display: none;">
        <div class="container">
            <div class="nav-header">
                <a href="/" class="nav-link">首页</a>
                <a href="/scientific-grouping" class="nav-link">科学分组</a>
                <a href="/fine-tuning" class="nav-link">分组微调</a>
                <a href="/data-recording" class="nav-link active">数据记录</a>
            </div>

            <h1>数据记录</h1>

        <!-- 第一个模块：分组信息 -->
        <div class="section">
            <div class="section-title">1. 分组信息</div>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="experiment-name">实验名称</label>
                        <select id="experiment-name" onchange="loadExperimentInfo()">
                            <option value="">-- 选择已有实验 --</option>
                        </select>
                        <input type="text" id="new-experiment-name" placeholder="或输入新实验名称" style="margin-top: 5px;">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="parameters">参数设置</label>
                        <input type="text" id="parameters" placeholder="输入参数名称，用逗号分隔（如：体重,摄食量,体温）">
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="group-count">组数</label>
                        <input type="number" id="group-count" min="1" value="4" onchange="updateGroupInfo()">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="group-type">分组类别</label>
                        <select id="group-type" onchange="updateGroupInfo()">
                            <option value="average">平均分组</option>
                            <option value="custom">自定义分组</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>组别信息</label>
                <div id="group-info-container">
                    <table class="group-info-table" id="group-info-table">
                        <thead>
                            <tr>
                                <th>组别名称</th>
                                <th>每组动物数量</th>
                                <th>每笼动物数量（逗号分隔）</th>
                            </tr>
                        </thead>
                        <tbody id="group-info-tbody">
                            <!-- 动态生成 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <button onclick="saveExperiment()">保存实验设置</button>
            <div id="experiment-message" class="error-message"></div>
        </div>

        <!-- 第二个模块：数据输入 -->
        <div class="section">
            <div class="section-title">2. 数据输入</div>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="data-date">记录日期</label>
                        <input type="date" id="data-date" value="">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button onclick="generateDataInputTable()" id="generate-table-btn">生成数据输入表</button>
                    </div>
                </div>
            </div>

            <div class="scrollable-table hidden" id="data-table-container">
                <table id="data-input-table">
                    <thead id="data-table-head">
                        <!-- 动态生成 -->
                    </thead>
                    <tbody id="data-table-body">
                        <!-- 动态生成 -->
                    </tbody>
                </table>
            </div>

            <div class="form-group hidden" id="data-actions">
                <button onclick="saveExperimentData()">保存数据</button>
                <button onclick="downloadDataCSV()">下载数据</button>
            </div>

            <div id="data-message" class="error-message"></div>
        </div>

        <!-- 第三个模块：数据展示 -->
        <div class="section">
            <div class="section-title">3. 数据展示</div>
            
            <div class="form-group">
                <label for="chart-experiment">选择实验</label>
                <select id="chart-experiment" onchange="loadChartData()">
                    <option value="">-- 选择实验 --</option>
                </select>
            </div>

            <div id="charts-container">
                <!-- 动态生成图表 -->
            </div>
        </div>
    </div>  <!-- main-content结束 -->

    <script>
        let currentExperiment = null;
        let chartLoadTimeout = null;

        // 统一处理各种逗号格式（中文、英文、全角、半角）
        function normalizeCommas(str) {
            if (!str) return str;
            // 将中文逗号（，）、全角逗号（，）、半角逗号（,）统一替换为英文逗号
            return str.replace(/[，,]/g, ',');
        }

        // 页面初始化已移至initializePage函数中

        // 加载实验列表
        async function loadExperiments() {
            try {
                const response = await fetch('/api/experiments');
                const data = await response.json();
                
                const experimentSelect = document.getElementById('experiment-name');
                const chartSelect = document.getElementById('chart-experiment');
                
                // 清空现有选项
                experimentSelect.innerHTML = '<option value="">-- 选择已有实验 --</option>';
                chartSelect.innerHTML = '<option value="">-- 选择实验 --</option>';
                
                // 添加实验选项
                data.experiments.forEach(exp => {
                    experimentSelect.innerHTML += `<option value="${exp}">${exp}</option>`;
                    chartSelect.innerHTML += `<option value="${exp}">${exp}</option>`;
                });
            } catch (error) {
                console.error('加载实验列表失败:', error);
            }
        }

        // 加载实验信息
        async function loadExperimentInfo() {
            const experimentName = document.getElementById('experiment-name').value;
            
            if (!experimentName) {
                // 清空表单
                document.getElementById('new-experiment-name').value = '';
                document.getElementById('parameters').value = '';
                document.getElementById('group-count').value = '4';
                document.getElementById('group-type').value = 'average';
                updateGroupInfo();
                return;
            }
            
            try {
                const response = await fetch(`/api/experiments/${experimentName}`);
                const data = await response.json();
                
                if (response.ok) {
                    // 填充表单
                    document.getElementById('new-experiment-name').value = experimentName;
                    document.getElementById('parameters').value = data.parameters;
                    document.getElementById('group-count').value = data.group_count;
                    document.getElementById('group-type').value = data.group_type;
                    
                    // 填充组别信息
                    updateGroupInfo();
                    const groupInfo = data.group_info;
                    const tbody = document.getElementById('group-info-tbody');
                    const rows = tbody.getElementsByTagName('tr');
                    
                    for (let i = 0; i < groupInfo.length && i < rows.length; i++) {
                        const cells = rows[i].getElementsByTagName('input');
                        cells[0].value = groupInfo[i].name || '';
                        cells[1].value = groupInfo[i].animal_count || '';
                        cells[2].value = groupInfo[i].cage_animals || '';
                    }
                }
            } catch (error) {
                console.error('加载实验信息失败:', error);
            }
        }

        // 更新组别信息表格
        function updateGroupInfo() {
            const groupCount = parseInt(document.getElementById('group-count').value) || 4;
            const groupType = document.getElementById('group-type').value;
            const tbody = document.getElementById('group-info-tbody');
            
            tbody.innerHTML = '';
            
            for (let i = 0; i < groupCount; i++) {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td><input type="text" placeholder="组${i+1}" value="组${i+1}"></td>
                    <td><input type="number" min="1" value="${groupType === 'average' ? (i === 0 ? '10' : '') : ''}" ${i > 0 && groupType === 'average' ? 'readonly' : ''}></td>
                    <td><input type="text" placeholder="如: 4,6" value=""></td>
                `;
                
                tbody.appendChild(row);
            }
        }

        // 保存实验设置
        async function saveExperiment() {
            const experimentName = document.getElementById('new-experiment-name').value || document.getElementById('experiment-name').value;
            const parameters = normalizeCommas(document.getElementById('parameters').value);
            const groupCount = parseInt(document.getElementById('group-count').value) || 0;
            const groupType = document.getElementById('group-type').value;
            
            if (!experimentName) {
                showMessage('experiment-message', '请输入实验名称', 'error');
                return;
            }
            
            if (!parameters) {
                showMessage('experiment-message', '请输入参数名称', 'error');
                return;
            }
            
            if (groupCount <= 0) {
                showMessage('experiment-message', '组数必须大于0', 'error');
                return;
            }
            
            // 收集组别信息
            const groupInfo = [];
            const rows = document.getElementById('group-info-tbody').getElementsByTagName('tr');
            
            for (let row of rows) {
                const inputs = row.getElementsByTagName('input');
                const name = inputs[0].value;
                const animalCount = parseInt(inputs[1].value) || 0;
                const cageAnimals = normalizeCommas(inputs[2].value);
                
                if (!name || animalCount <= 0) {
                    showMessage('experiment-message', '请填写完整的组别信息', 'error');
                    return;
                }
                
                groupInfo.push({
                    name: name,
                    animal_count: animalCount,
                    cage_animals: cageAnimals
                });
            }
            
            try {
                const response = await fetch('/api/experiments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        experiment_name: experimentName,
                        parameters: parameters,
                        group_count: groupCount,
                        group_type: groupType,
                        group_info: groupInfo
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('experiment-message', '实验设置保存成功', 'success');
                    currentExperiment = experimentName;
                    loadExperiments();
                } else {
                    showMessage('experiment-message', data.error || '保存失败', 'error');
                }
            } catch (error) {
                console.error('保存实验设置失败:', error);
                showMessage('experiment-message', '保存失败，请检查网络连接', 'error');
            }
        }

        // 生成数据输入表格
        async function generateDataInputTable() {
            const experimentName = document.getElementById('new-experiment-name').value || document.getElementById('experiment-name').value;
            const parameters = normalizeCommas(document.getElementById('parameters').value);
            const date = document.getElementById('data-date').value;
            
            if (!experimentName) {
                showMessage('data-message', '请先选择或输入实验名称', 'error');
                return;
            }
            
            if (!parameters) {
                showMessage('data-message', '请输入参数名称', 'error');
                return;
            }
            
            if (!date) {
                showMessage('data-message', '请选择日期', 'error');
                return;
            }
            
            // 获取组别信息
            const groupInfo = [];
            const rows = document.getElementById('group-info-tbody').getElementsByTagName('tr');
            
            for (let row of rows) {
                const inputs = row.getElementsByTagName('input');
                const name = inputs[0].value;
                const animalCount = parseInt(inputs[1].value) || 0;
                const cageAnimals = normalizeCommas(inputs[2].value);
                
                if (name && animalCount > 0) {
                    groupInfo.push({
                        name: name,
                        animal_count: animalCount,
                        cage_animals: cageAnimals
                    });
                }
            }
            
            if (groupInfo.length === 0) {
                showMessage('data-message', '请先设置组别信息', 'error');
                return;
            }
            
            // 检查该日期是否已有数据和锁定状态
            let existingData = null;
            let hasData = false;
            let isLocked = false;
            
            try {
                // 检查数据是否存在
                const response = await fetch(`/api/experiment-data/${experimentName}/${date}`);
                const result = await response.json();
                
                if (response.ok) {
                    hasData = result.has_data;
                    existingData = result.data;
                }
                
                // 检查锁定状态
                const lockResponse = await fetch(`/api/experiment-data/lock-status?experiment_name=${encodeURIComponent(experimentName)}&date=${date}`);
                const lockResult = await lockResponse.json();
                
                if (lockResponse.ok) {
                    isLocked = lockResult.is_locked;
                    
                    if (isLocked) {
                        showMessage('data-message', '该日期数据已锁定，如需修改请点击"修改数据"按钮', 'warning');
                    } else if (hasData) {
                        showMessage('data-message', '该日期已有数据，可以继续编辑', 'info');
                    }
                }
            } catch (error) {
                console.error('检查已有数据失败:', error);
            }
            
            // 生成表格头部
            const thead = document.getElementById('data-table-head');
            const paramList = parameters.split(',').map(p => p.trim());
            
            // 第一行：参数类型选择（如果已有数据则隐藏）
            let typeRowHTML = hasData ? '' : '<tr><th></th>';
            if (!hasData) {
                paramList.forEach((param, index) => {
                    typeRowHTML += `
                        <th>
                            <select id="param-type-${index}" onchange="updateInputTypes(${index})" style="width: 100%; padding: 4px;">
                                <option value="number">数字</option>
                                <option value="text">文本</option>
                            </select>
                        </th>
                    `;
                });
                typeRowHTML += '</tr>';
            }
            
            // 第二行：参数名称
            let headerRowHTML = '<tr><th>动物编号</th>';
            paramList.forEach(p => {
                headerRowHTML += `<th>${p}</th>`;
            });
            headerRowHTML += '</tr>';
            
            thead.innerHTML = typeRowHTML + headerRowHTML;
            
            // 创建已有数据的查找映射
            const existingDataMap = {};
            if (hasData && existingData) {
                existingData.forEach(item => {
                    existingDataMap[item.animal_id] = item;
                });
            }
            
            // 生成表格内容
            const tbody = document.getElementById('data-table-body');
            tbody.innerHTML = '';
            
            groupInfo.forEach(group => {
                const animalCount = group.animal_count;
                const cageAnimals = group.cage_animals ? group.cage_animals.split(',').map(n => parseInt(n.trim())) : [animalCount];
                
                let animalIndex = 0;
                let cageIndex = 1;
                
                cageAnimals.forEach(cageSize => {
                    for (let i = 0; i < cageSize; i++) {
                        const row = document.createElement('tr');
                        const animalId = `${group.name}-${cageIndex}-${i}`;
                        
                        // 查找该动物的已保存数据
                        const savedData = existingDataMap[animalId];
                        
                        let cellsHTML = `<td>${animalId}</td>`;
                        
                        paramList.forEach((param, index) => {
                            const savedValue = savedData ? (savedData[param] || '') : '';
                            const readonlyAttr = isLocked ? 'readonly' : '';
                            const styleAttr = isLocked ? 'style="background-color: #f5f5f5; cursor: not-allowed;"' : '';
                            const disabledAttr = isLocked ? 'disabled' : '';
                            
                            cellsHTML += `<td><input type="number" step="0.01" placeholder="0.00" class="param-input-${index}" inputmode="decimal" 
                                value="${savedValue}" ${readonlyAttr} ${styleAttr} ${disabledAttr}
                                onchange="saveSingleDataPoint('${animalId}', '${group.name}', '${param}', this.value, ${index})"
                                oninput="debounceSave(this, '${animalId}', '${group.name}', '${param}', ${index})"></td>`;
                        });
                        
                        row.innerHTML = cellsHTML;
                        tbody.appendChild(row);
                        animalIndex++;
                    }
                    cageIndex++;
                });
            });
            
            // 显示表格和操作按钮
            document.getElementById('data-table-container').classList.remove('hidden');
            
            // 根据数据状态和锁定状态显示不同的按钮
            const dataActions = document.getElementById('data-actions');
            if (hasData && isLocked) {
                // 数据已锁定，显示修改数据按钮
                dataActions.innerHTML = `
                    <button onclick="unlockData()" class="btn-warning">修改数据</button>
                    <button onclick="downloadDataCSV()" class="btn-secondary">导出CSV</button>
                `;
            } else if (hasData) {
                // 有数据但未锁定，显示保存和锁定按钮
                dataActions.innerHTML = `
                    <button onclick="saveExperimentData()" class="btn-primary">保存数据</button>
                    <button onclick="lockData()" class="btn-success">锁定数据</button>
                    <button onclick="downloadDataCSV()" class="btn-secondary">导出CSV</button>
                `;
            } else {
                // 没有数据，显示保存按钮
                dataActions.innerHTML = `
                    <button onclick="exportData()" class="btn-primary">导出数据</button>
                    <button onclick="enableForceOverwrite()" class="btn-warning" id="force-overwrite-btn" style="background-color: #ff9800; margin-left: 10px;">强制覆写</button>
                    <div id="readonly-hint" style="margin-top: 10px; color: #666; font-size: 14px;">
                        <strong>提示:</strong> 该日期的数据已保存,处于只读状态。如需修改,请点击"强制覆写"按钮。
                    </div>
                `;
            } else {
                dataActions.innerHTML = `
                    <button onclick="saveExperimentData()" class="btn-primary">保存数据</button>
                    <button onclick="exportData()" class="btn-secondary">导出数据</button>
                `;
            }
            dataActions.classList.remove('hidden');
        }
        
        // 启用强制覆写模式
        function enableForceOverwrite() {
            // 确认操作
            if (!confirm('警告：强制覆写将允许修改已保存的数据。确定要继续吗？')) {
                return;
            }
            
            // 获取所有输入框
            const tbody = document.getElementById('data-table-body');
            const inputs = tbody.querySelectorAll('input');
            
            // 移除只读属性和样式
            inputs.forEach(input => {
                input.removeAttribute('readonly');
                input.style.backgroundColor = '';
                input.style.cursor = '';
            });
            
            // 更新按钮区域
            const dataActions = document.getElementById('data-actions');
            dataActions.innerHTML = `
                <button onclick="saveExperimentDataOverwrite()" class="btn-primary">保存数据</button>
                <button onclick="exportData()" class="btn-secondary">导出数据</button>
                <button onclick="cancelOverwrite()" class="btn-secondary" style="margin-left: 10px;">取消覆写</button>
                <div style="margin-top: 10px; color: #ff5722; font-size: 14px;">
                    <strong>警告:</strong> 当前处于覆写模式,保存后将覆盖原有数据!
                </div>
            `;
            
            showMessage('data-message', '已启用覆写模式,可以修改数据了', 'success');
        }
        
        // 取消覆写模式
        function cancelOverwrite() {
            if (confirm('确定要取消覆写模式吗？未保存的修改将丢失。')) {
                // 重新生成表格,恢复只读状态
                generateDataInputTable();
            }
        }
        
        // 保存数据(覆写模式)
        async function saveExperimentDataOverwrite() {
            const experimentName = document.getElementById('new-experiment-name').value || document.getElementById('experiment-name').value;
            const date = document.getElementById('data-date').value;
            const parameters = normalizeCommas(document.getElementById('parameters').value);
            
            if (!experimentName || !date) {
                showMessage('data-message', '请选择实验名称和日期', 'error');
                return;
            }
            
            // 再次确认覆写操作
            if (!confirm('确定要覆写该日期的数据吗？此操作不可撤销！')) {
                return;
            }
            
            // 收集表格数据
            const data = [];
            const tbody = document.getElementById('data-table-body');
            const rows = tbody.getElementsByTagName('tr');
            const paramList = parameters.split(',').map(p => p.trim());
            
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                const animalId = cells[0].textContent;
                
                // 从动物编号中提取组别名称
                const groupName = animalId.split('-').slice(0, -2).join('-');
                
                const rowData = {
                    animal_id: animalId,
                    group_name: groupName
                };
                
                paramList.forEach((param, index) => {
                    const input = cells[index + 1].getElementsByTagName('input')[0];
                    const inputType = input.type;
                    
                    if (inputType === 'number') {
                        rowData[param] = parseFloat(input.value) || 0;
                    } else {
                        rowData[param] = input.value || '';
                    }
                });
                
                data.push(rowData);
            }
            
            try {
                const response = await fetch('/api/experiment-data/overwrite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        experiment_name: experimentName,
                        date: date,
                        data: data
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('data-message', '数据覆写成功', 'success');
                    // 重新生成表格,恢复只读状态
                    setTimeout(() => {
                        generateDataInputTable();
                    }, 1500);
                } else {
                    showMessage('data-message', result.error || '保存失败', 'error');
                }
            } catch (error) {
                console.error('保存数据失败:', error);
                showMessage('data-message', '保存失败,请检查网络连接', 'error');
            }
        }
        
        // 更新输入框类型
        function updateInputTypes(paramIndex) {
            const typeSelect = document.getElementById(`param-type-${paramIndex}`);
            const inputType = typeSelect.value;
            const inputs = document.querySelectorAll(`.param-input-${paramIndex}`);
            
            inputs.forEach(input => {
                if (inputType === 'number') {
                    input.type = 'number';
                    input.step = '0.01';
                    input.placeholder = '0.00';
                    input.setAttribute('inputmode', 'decimal');
                } else {
                    input.type = 'text';
                    input.removeAttribute('step');
                    input.placeholder = '';
                    input.setAttribute('inputmode', 'text');
                }
            });
        }

        // 防抖函数，避免频繁保存
        let saveTimeouts = {};
        
        function debounceSave(input, animalId, groupName, paramName, paramIndex) {
            // 清除之前的定时器
            const key = `${animalId}_${paramIndex}`;
            if (saveTimeouts[key]) {
                clearTimeout(saveTimeouts[key]);
            }
            
            // 设置新的定时器，1秒后保存
            saveTimeouts[key] = setTimeout(() => {
                saveSingleDataPoint(animalId, groupName, paramName, input.value, paramIndex);
            }, 1000);
        }
        
        // 实时保存单个数据点
        async function saveSingleDataPoint(animalId, groupName, paramName, value, paramIndex) {
            const experimentName = document.getElementById('new-experiment-name').value || document.getElementById('experiment-name').value;
            const date = document.getElementById('data-date').value;
            
            if (!experimentName || !date) {
                return;
            }
            
            // 显示保存状态
            const input = document.querySelector(`.param-input-${paramIndex}[oninput*="${animalId}"]`);
            if (input) {
                input.style.backgroundColor = '#fff3cd'; // 黄色背景表示正在保存
            }
            
            try {
                const response = await fetch('/api/experiment-data/realtime', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        experiment_name: experimentName,
                        date: date,
                        animal_id: animalId,
                        group_name: groupName,
                        parameter_name: paramName,
                        parameter_value: value
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // 保存成功，恢复正常背景色
                    if (input) {
                        input.style.backgroundColor = '#d4edda'; // 绿色背景表示保存成功
                        setTimeout(() => {
                            input.style.backgroundColor = '';
                        }, 1000);
                    }
                } else {
                    // 保存失败，显示错误
                    if (input) {
                        input.style.backgroundColor = '#f8d7da'; // 红色背景表示保存失败
                        setTimeout(() => {
                            input.style.backgroundColor = '';
                        }, 2000);
                    }
                    console.error('保存失败:', result.error);
                }
            } catch (error) {
                console.error('保存单个数据点失败:', error);
                if (input) {
                    input.style.backgroundColor = '#f8d7da'; // 红色背景表示保存失败
                    setTimeout(() => {
                        input.style.backgroundColor = '';
                    }, 2000);
                }
            }
        }
        
        // 锁定数据
        async function lockData() {
            const experimentName = document.getElementById('new-experiment-name').value || document.getElementById('experiment-name').value;
            const date = document.getElementById('data-date').value;
            
            if (!experimentName || !date) {
                showMessage('data-message', '请选择实验名称和日期', 'error');
                return;
            }
            
            if (!confirm('确定要锁定数据吗？锁定后将无法修改，但会自动导出CSV备份。')) {
                return;
            }
            
            try {
                const response = await fetch('/api/experiment-data/lock', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        experiment_name: experimentName,
                        date: date,
                        locked_by: 'user'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('data-message', '数据已锁定并导出', 'success');
                    // 重新加载数据表格以更新锁定状态
                    loadDataInputs();
                } else {
                    showMessage('data-message', result.error || '锁定失败', 'error');
                }
            } catch (error) {
                console.error('锁定数据失败:', error);
                showMessage('data-message', '锁定失败，请检查网络连接', 'error');
            }
        }
        
        // 解锁数据
        async function unlockData() {
            const experimentName = document.getElementById('new-experiment-name').value || document.getElementById('experiment-name').value;
            const date = document.getElementById('data-date').value;
            
            if (!experimentName || !date) {
                showMessage('data-message', '请选择实验名称和日期', 'error');
                return;
            }
            
            if (!confirm('确定要解锁数据吗？解锁后可以继续修改数据。')) {
                return;
            }
            
            try {
                const response = await fetch('/api/experiment-data/unlock', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        experiment_name: experimentName,
                        date: date
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('data-message', '数据已解锁，可以继续编辑', 'success');
                    // 重新加载数据表格以更新锁定状态
                    loadDataInputs();
                } else {
                    showMessage('data-message', result.error || '解锁失败', 'error');
                }
            } catch (error) {
                console.error('解锁数据失败:', error);
                showMessage('data-message', '解锁失败，请检查网络连接', 'error');
            }
        }

        // 保存实验数据
        async function saveExperimentData() {
            const experimentName = document.getElementById('new-experiment-name').value || document.getElementById('experiment-name').value;
            const date = document.getElementById('data-date').value;
            const parameters = normalizeCommas(document.getElementById('parameters').value);
            
            if (!experimentName || !date) {
                showMessage('data-message', '请选择实验名称和日期', 'error');
                return;
            }
            
            // 收集表格数据
            const data = [];
            const tbody = document.getElementById('data-table-body');
            const rows = tbody.getElementsByTagName('tr');
            const paramList = parameters.split(',').map(p => p.trim());
            
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                const animalId = cells[0].textContent;
                
                // 从动物编号中提取组别名称（格式：组名-笼号-动物号）
                const groupName = animalId.split('-').slice(0, -2).join('-');
                
                const rowData = {
                    animal_id: animalId,
                    group_name: groupName
                };
                
                paramList.forEach((param, index) => {
                    const input = cells[index + 1].getElementsByTagName('input')[0];
                    const inputType = input.type;
                    
                    if (inputType === 'number') {
                        rowData[param] = parseFloat(input.value) || 0;
                    } else {
                        rowData[param] = input.value || '';
                    }
                });
                
                data.push(rowData);
            }
            
            try {
                const response = await fetch('/api/experiment-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        experiment_name: experimentName,
                        date: date,
                        data: data
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('data-message', '数据保存成功', 'success');
                    // 保存成功后自动锁定数据
                    lockData();
                } else {
                    showMessage('data-message', result.error || '保存失败', 'error');
                }
            } catch (error) {
                console.error('保存实验数据失败:', error);
                showMessage('data-message', '保存失败，请检查网络连接', 'error');
            }
        }

        // 下载数据CSV
        function downloadDataCSV() {
            const experimentName = document.getElementById('new-experiment-name').value || document.getElementById('experiment-name').value;
            const date = document.getElementById('data-date').value;
            const parameters = normalizeCommas(document.getElementById('parameters').value);
            
            if (!experimentName || !date) {
                showMessage('data-message', '请选择实验名称和日期', 'error');
                return;
            }
            
            // 收集表格数据
            const tbody = document.getElementById('data-table-body');
            const rows = tbody.getElementsByTagName('tr');
            const paramList = parameters.split(',').map(p => p.trim());
            
            // 生成CSV内容
            let csvContent = '\ufeff'; // BOM for UTF-8
            csvContent += '日期,组别名称,动物编号,' + paramList.join(',') + '\n';
            
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                const animalId = cells[0].textContent;
                
                // 从动物编号中提取组别名称
                const groupName = animalId.split('-').slice(0, -2).join('-');
                
                let rowData = `${date},${groupName},${animalId}`;
                
                paramList.forEach((param, index) => {
                    const input = cells[index + 1].getElementsByTagName('input')[0];
                    const value = input.type === 'number' ? (parseFloat(input.value) || 0) : (input.value || '');
                    rowData += ',' + value;
                });
                
                csvContent += rowData + '\n';
            }
            
            // 下载文件
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `${experimentName}_${date}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 加载图表数据 - 带防抖
        async function loadChartData() {
            // 清除之前的定时器
            if (chartLoadTimeout) {
                clearTimeout(chartLoadTimeout);
            }
            
            const experimentName = document.getElementById('chart-experiment').value;
            const container = document.getElementById('charts-container');
            
            if (!experimentName) {
                container.innerHTML = '';
                return;
            }
            
            // 防抖延迟
            chartLoadTimeout = setTimeout(async () => {
                // 显示加载提示
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">加载中...</p>';
                
                try {
                    // 添加时间戳参数避免缓存
                    const timestamp = new Date().getTime();
                    const response = await fetch(`/api/experiment-charts/${experimentName}?t=${timestamp}`);
                    const result = await response.json();
                    
                    if (response.ok) {
                        renderCharts(result.charts);
                    } else {
                        console.error('加载图表失败:', result.error);
                        container.innerHTML = `<p style="text-align: center; color: #f44336; padding: 20px;">加载失败: ${result.error || '未知错误'}</p>`;
                    }
                } catch (error) {
                    console.error('加载图表失败:', error);
                    container.innerHTML = '<p style="text-align: center; color: #f44336; padding: 20px;">加载失败,请检查网络连接</p>';
                }
            }, 150); // 150ms 防抖延迟
        }

        // 渲染图表
        function renderCharts(charts) {
            const container = document.getElementById('charts-container');
            
            // 清空容器
            container.innerHTML = '';
            
            // 验证数据
            if (!charts || charts.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">暂无数据</p>';
                return;
            }
            
            // 为每个参数显示图表图片
            charts.forEach(chart => {
                const chartDiv = document.createElement('div');
                chartDiv.className = 'chart-container';
                chartDiv.style.position = 'relative';
                chartDiv.style.padding = '40px 10px 20px 60px'; // 为纵坐标标题留出空间
                
                // 添加中文参数名称标题
                const title = document.createElement('h3');
                title.textContent = `${chart.parameter} 变化趋势`;
                title.style.textAlign = 'center';
                title.style.marginBottom = '15px';
                title.style.position = 'absolute';
                title.style.top = '10px';
                title.style.left = '0';
                title.style.right = '0';
                chartDiv.appendChild(title);
                
                // 添加旋转90度的纵坐标标题
                const yAxisLabel = document.createElement('div');
                yAxisLabel.textContent = chart.parameter;
                yAxisLabel.style.position = 'absolute';
                yAxisLabel.style.left = '10px';
                yAxisLabel.style.top = '50%';
                yAxisLabel.style.transform = 'translateY(-50%) rotate(-90deg)';
                yAxisLabel.style.transformOrigin = 'center';
                yAxisLabel.style.fontSize = '14px';
                yAxisLabel.style.color = '#666';
                yAxisLabel.style.whiteSpace = 'nowrap';
                chartDiv.appendChild(yAxisLabel);
                
                // 添加图表图片
                const img = document.createElement('img');
                // 添加时间戳避免浏览器缓存
                const timestamp = new Date().getTime();
                img.src = `${chart.file_path}?t=${timestamp}`;
                img.alt = `${chart.parameter} 变化趋势`;
                img.className = 'chart-image';
                chartDiv.appendChild(img);
                
                // 添加中文"日期"标签
                const dateLabel = document.createElement('div');
                dateLabel.textContent = '日期';
                dateLabel.style.textAlign = 'center';
                dateLabel.style.marginTop = '15px';
                dateLabel.style.fontSize = '14px';
                dateLabel.style.color = '#666';
                chartDiv.appendChild(dateLabel);
                
                container.appendChild(chartDiv);
            });
        }

        // 显示消息
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = type === 'success' ? 'success-message' : 'error-message';
            
            setTimeout(() => {
                element.textContent = '';
            }, 5000);
        }

        // 验证密码
        function verifyPassword() {
            try {
                const password = document.getElementById('access-password').value;
                const passwordError = document.getElementById('password-error');
                const passwordContainer = document.getElementById('password-container');
                const mainContent = document.getElementById('main-content');
                
                // 检查密码是否为空
                if (!password) {
                    passwordError.textContent = '请输入密码';
                    passwordError.style.display = 'block';
                    setTimeout(() => {
                        passwordError.style.display = 'none';
                    }, 3000);
                    return;
                }
                
                // 从后端获取正确的密码
                const correctPassword = '{{ password }}'; // 从模板变量获取
                
                console.log('输入密码:', password);
                console.log('正确密码:', correctPassword);
                
                if (password === correctPassword) {
                    passwordContainer.style.display = 'none';
                    mainContent.style.display = 'block';
                    // 初始化页面功能
                    initializePage();
                } else {
                    passwordError.textContent = '密码错误，请重试';
                    passwordError.style.display = 'block';
                    document.getElementById('access-password').value = '';
                    // 3秒后隐藏错误信息
                    setTimeout(() => {
                        passwordError.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                console.error('密码验证出错:', error);
                const passwordError = document.getElementById('password-error');
                passwordError.textContent = '验证出错，请刷新页面重试';
                passwordError.style.display = 'block';
            }
        }

        // 页面初始化函数（从原来的DOMContentLoaded中提取）
        function initializePage() {
            // 设置今天的日期
            document.getElementById('data-date').valueAsDate = new Date();
            
            // 加载实验列表
            loadExperiments();
            
            // 初始化组别信息表格
            updateGroupInfo();
        }

// 页面加载时设置事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，开始初始化');
            
            // 测试verifyPassword函数是否存在
            if (typeof verifyPassword === 'function') {
                console.log('verifyPassword函数已定义');
            } else {
                console.error('verifyPassword函数未定义');
            }
            
            const passwordInput = document.getElementById('access-password');
            const verifyBtn = document.getElementById('verify-btn');
            
            if (passwordInput) {
                console.log('找到密码输入框');
                // 自动聚焦密码输入框
                passwordInput.focus();
                
                // 添加回车键监听
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        console.log('回车键触发密码验证');
                        verifyPassword();
                    }
                });
            } else {
                console.error('未找到密码输入框');
            }
            
            if (verifyBtn) {
                console.log('找到验证按钮');
                // 添加点击事件监听器作为备用
                verifyBtn.addEventListener('click', function(e) {
                    console.log('点击验证按钮');
                    e.preventDefault();
                    verifyPassword();
                });
            } else {
                console.error('未找到验证按钮');
            }
        });
    </script>
</body>
</html>