"""
é…ç½®ç®¡ç†é¡µé¢ - ä¼˜åŒ–ç‰ˆ
æ”¯æŒAPIæ ¼å¼åˆ†ç±»å’Œè‡ªå®šä¹‰æä¾›å•†
ç§»é™¤äº†åç«¯é€»è¾‘ï¼Œæå‡å‰ç«¯æ€§èƒ½
"""

import streamlit as st
import json
import sys
from typing import Dict, List, Any


def run():
    # é¡µé¢é…ç½®
    st.set_page_config(
        page_title="é…ç½®ç®¡ç†",
        page_icon="ğŸ›ï¸",
        layout="wide"
    )

    # ææ—©æœŸæ‰§è¡Œçš„JavaScript
    st.markdown("""
    <script>
    // é¡µé¢åŠ è½½å‰ç«‹å³æ‰§è¡Œ
    (function() {
        // ä¿å­˜åŸå§‹æ–¹æ³•
        const originalAddEventListener = EventTarget.prototype.addEventListener;
        const originalWarn = console.warn;
        const originalError = console.error;

        // é‡å†™addEventListenerï¼Œè‡ªåŠ¨æ·»åŠ passive
        EventTarget.prototype.addEventListener = function(type, listener, options) {
            if (['wheel', 'touchmove', 'scroll', 'touchstart', 'touchend'].includes(type)) {
                if (!options) options = {};
                if (typeof options !== 'object') options = {};
                options.passive = true;
            }
            return originalAddEventListener.call(this, type, listener, options);
        };

        // æŠ‘åˆ¶æ‰€æœ‰ç›¸å…³è­¦å‘Š
        function shouldSuppress(msg) {
            return msg &&
                   typeof msg === 'string' &&
                   (msg.includes('non-passive') ||
                    msg.includes('Violation') ||
                    msg.includes('wheel') ||
                    msg.includes('scroll-blocking') ||
                    msg.includes('Added non-passive'));
        }

        console.warn = function(...args) {
            if (shouldSuppress(args[0])) return;
            try { originalWarn.apply(console, args); } catch(e) {}
        };

        console.error = function(...args) {
            if (shouldSuppress(args[0])) return;
            try { originalError.apply(console, args); } catch(e) {}
        };

        // é¡µé¢åŠ è½½å®Œæˆåæ¸…ç†
        window.addEventListener('load', function() {
            setTimeout(function() {
                // æ¸…é™¤æ§åˆ¶å°ä¸­å·²æœ‰çš„è­¦å‘Š
                if (console.clear) {
                    // åªæ¸…é™¤ç‰¹å®šè­¦å‘Š
                    const logs = [];
                    const origLog = console.log;
                    console.log = function(...args) {
                        if (!shouldSuppress(args[0])) origLog.apply(console, args);
                    };
                }
            }, 500);
        });

    })();
    </script>
    """, unsafe_allow_html=True)

    st.title("ğŸ›ï¸ é…ç½®ç®¡ç†")

    # è¯´æ˜è­¦å‘Šä¿¡æ¯
    with st.expander("â„¹ï¸ å…³äºå¼€å‘è€…å·¥å…·è­¦å‘Š", expanded=False):
        st.markdown("""
        **å¦‚æœæ‚¨åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­çœ‹åˆ°è­¦å‘Šï¼Œè¯·å¿½ç•¥ï¼š**

        1. **Non-passive event listener è­¦å‘Š**
           - è¿™äº›è­¦å‘Šæ¥è‡ªæµè§ˆå™¨æ€§èƒ½æ£€æµ‹
           - ä¸å½±å“åº”ç”¨ç¨‹åºåŠŸèƒ½
           - æˆ‘ä»¬å·²è‡ªåŠ¨ä¼˜åŒ–äº‹ä»¶ç›‘å¬å™¨

        2. **å¦‚ä½•éšè—è¿™äº›è­¦å‘Š**
           - æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·
           - ç‚¹å‡» "Console" é€‰é¡¹å¡
           - åœ¨è¿‡æ»¤æ¡†ä¸­è¾“å…¥ï¼š`-Violation`
           - æˆ–å‹¾é€‰ "Hide all" å¤é€‰æ¡†

        3. **ä¸å½±å“åŠŸèƒ½**
           - æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
           - é¡µé¢å“åº”æ€§è‰¯å¥½
           - è¿™æ˜¯æ¡†æ¶çº§åˆ«çš„è­¦å‘Š
        """)

    # é¡µé¢åŠ è½½åçš„æ ·å¼
    st.markdown("""
    <style>
    /* ä¼˜åŒ–æ»šåŠ¨æ€§èƒ½ */
    .main {
        scroll-behavior: smooth;
    }

    /* APIå¯†é’¥è¾“å…¥æ¡†æ ·å¼ */
    [data-testid="text-input"] input[type="password"] {
        font-family: monospace;
        letter-spacing: 0.5px;
        -webkit-text-security: disc;
    }

    /* é˜»æ­¢æµè§ˆå™¨è‡ªåŠ¨å¡«å……å’Œä¿å­˜å¯†ç æç¤º */
    [data-testid="text-input"] input[type="password"] {
        autofill: none !important;
        background-attachment: fixed;
    }

    /* éšè—å¯†ç å­—æ®µçš„æµè§ˆå™¨æç¤º */
    [data-testid="text-input"] input:-webkit-autofill,
    [data-testid="text-input"] input:-webkit-autofill:hover,
    [data-testid="text-input"] input:-webkit-autofill:focus {
        -webkit-box-shadow: 0 0 0 1000px white inset !important;
    }

    /* è“è‰²URLæ¡†æ ·å¼å¢å¼º */
    .url-preview-box {
        background-color: #E3F2FD;
        border: 1px solid #90CAF9;
        border-radius: 0.25rem;
        padding: 0.5rem 0.75rem;
        height: 38px;
        display: flex;
        align-items: center;
        font-family: monospace;
        font-size: 0.875rem;
        color: #0D47A1;
        word-break: break-all;
    }

    /* å®Œæ•´URLè¾“å…¥æ¡†è“è‰²æ ·å¼ */
    [data-testid="text-input"] input:disabled {
        background-color: #E3F2FD !important;
        border-color: #90CAF9 !important;
        color: #0D47A1 !important;
        font-family: monospace !important;
    }

    /* RAGFlowå¯†ç å­—æ®µæ ·å¼ */
    div[data-baseweb="input"] input[type="password"] {
        font-family: monospace;
        letter-spacing: 0.5px;
    }

    /* éšè—ç‰¹å®šè­¦å‘Šå…ƒç´  */
    [data-testid="stNotification"],
    .stException {
        display: none !important;
    }
    </style>
    """, unsafe_allow_html=True)

    # æ ‡ç­¾é¡µ
    tab1, tab2, tab3 = st.tabs(["APIå¯†é’¥ç®¡ç†", "æ¨¡å‹é…ç½®", "ç³»ç»Ÿé…ç½®"])

    with tab1:
        st.subheader("ğŸ”‘ APIå¯†é’¥å’Œç«¯ç‚¹ç®¡ç†")

        try:
            from ai_researcher.secrets_manager import get_secrets_manager

            # å†…ç½®å¸¸ç”¨æä¾›å•†
            COMMON_PROVIDERS = {
                "openai": {
                    "name": "OpenAI å…¼å®¹æ ¼å¼",
                    "default_url": "https://api.openai.com/v1",
                    "description": "OpenAIã€DeepSeekã€æ™ºè°±æ¸…è¨€ã€æœˆä¹‹æš—é¢ã€é›¶ä¸€ä¸‡ç‰©ç­‰"
                },
                "anthropic": {
                    "name": "Anthropic å…¼å®¹æ ¼å¼",
                    "default_url": "https://api.anthropic.com",
                    "description": "Anthropic Claudeç­‰"
                },
                "gemini": {
                    "name": "Gemini åŸç”Ÿæ ¼å¼",
                    "default_url": "https://generativelanguage.googleapis.com/v1",
                    "description": "Google Geminiç­‰"
                },
                "dashscope": {
                    "name": "é˜¿é‡Œå·´å·´ DASHSCOPE",
                    "default_url": "https://dashscope.aliyuncs.com/compatible-mode/v1",
                    "description": "é€šä¹‰åƒé—®ã€é˜¿é‡Œå·´å·´äº‘ç­‰"
                },
                "zai": {
                    "name": "BIGMODEL ZAI",
                    "default_url": "https://open.bigmodel.cn/api/paas/v4",
                    "description": "æ™ºè°±GLMã€BIGMODELç­‰"
                },
                "custom": {
                    "name": "è‡ªå®šä¹‰",
                    "default_url": "",
                    "description": "è‡ªå®šä¹‰APIæ ¼å¼"
                }
            }

            # ==================== APIå¯†é’¥è®¾ç½® ====================
            st.markdown("#### APIå¯†é’¥è®¾ç½®")

            # åˆå§‹åŒ–session_state
            if 'temp_api_config' not in st.session_state:
                st.session_state['temp_api_config'] = {
                    'provider_name': '',
                    'tag': '',
                    'test_model_name': '',
                    'api_key': '',
                    'base_url': ''
                }

            # ç¬¬ä¸€è¡Œï¼š3ä¸ªè¾“å…¥æ¡†
            col1, col2, col3 = st.columns(3)

            with col1:
                provider_name = st.text_input(
                    "ä¾›åº”å•†åç§°",
                    placeholder="è¾“å…¥ä¾›åº”å•†åç§°ï¼ˆå¦‚ï¼šopenai, anthropic, gemini ç­‰ï¼‰",
                    key="provider_name",
                    value=st.session_state['temp_api_config']['provider_name']
                )


            with col2:
                api_key = st.text_input(
                    "API-KEY",
                    type="password",
                    placeholder="è¾“å…¥æ‚¨çš„APIå¯†é’¥...",
                    key="api_key",
                    value=st.session_state['temp_api_config']['api_key']
                )

            with col3:
                # å¦‚æœsession_stateä¸­æœ‰å€¼ï¼Œä½¿ç”¨è¯¥å€¼ï¼›å¦åˆ™æ ¹æ®ä¾›åº”å•†åç§°è·å–é»˜è®¤å€¼
                if st.session_state['temp_api_config']['base_url']:
                    default_value = st.session_state['temp_api_config']['base_url']
                elif provider_name and provider_name in COMMON_PROVIDERS:
                    default_value = COMMON_PROVIDERS[provider_name]["default_url"]
                else:
                    default_value = ""

                base_url = st.text_input(
                    "EndPoint(ç«¯ç‚¹)",
                    value=default_value,
                    placeholder="https://api.example.com",
                    key="base_url"
                )

            # ç¬¬äºŒè¡Œï¼šæ ‡ç­¾è¾“å…¥æ¡†å’Œå®Œæ•´URLå±•ç¤ºæ¡†ï¼ˆ2åˆ—å¸ƒå±€ï¼‰
            col1, col2 = st.columns([1, 2])

            with col1:
                tag = st.text_input(
                    "æ ‡ç­¾",
                    placeholder="ä¾‹å¦‚ï¼šç”Ÿäº§ç¯å¢ƒ, æµ‹è¯•ç¯å¢ƒ, å¼€å‘ç¯å¢ƒ...",
                    key="tag",
                    value=st.session_state['temp_api_config']['tag']
                )

            with col2:
                # ç”Ÿæˆä¸‰ç§æ ¼å¼çš„å®Œæ•´URLé€‰é¡¹
                url_options = []
                url_values = {}

                if base_url:
                    # OpenAIæ ¼å¼
                    if base_url.endswith('/'):
                        openai_url = f"{base_url}chat/completions"
                    else:
                        openai_url = f"{base_url}/v1/chat/completions"
                    url_options.append(f"OpenAIæ ¼å¼: {openai_url}")
                    url_values[url_options[-1]] = openai_url

                    # Geminiæ ¼å¼
                    if base_url.endswith('/'):
                        gemini_url = f"{base_url}models/gemini-pro:generateContent"
                    else:
                        gemini_url = f"{base_url}/models/gemini-pro:generateContent"
                    url_options.append(f"Geminiæ ¼å¼: {gemini_url}")
                    url_values[url_options[-1]] = gemini_url

                    # Anthropicæ ¼å¼
                    if base_url.endswith('/'):
                        anthropic_url = f"{base_url}messages"
                    else:
                        anthropic_url = f"{base_url}/v1/messages"
                    url_options.append(f"Anthropicæ ¼å¼: {anthropic_url}")
                    url_values[url_options[-1]] = anthropic_url

                # å®Œæ•´URLä¸‹æ‹‰é€‰æ‹©æ¡†ï¼ˆä¸æ ‡ç­¾è¾“å…¥æ¡†ç»“æ„ä¸€è‡´ï¼‰
                selected_url_label = st.selectbox(
                    "å®Œæ•´URL",
                    options=url_options if url_options else ["è¯·å…ˆè¾“å…¥EndPointåœ°å€"],
                    key="full_url_select",
                    disabled=not url_options
                )

                # è·å–é€‰ä¸­çš„å®Œæ•´URL
                selected_full_url = url_values.get(selected_url_label, "") if url_options else ""

            # åˆ†éš”çº¿
            st.markdown("<hr style='border: 2px solid #e0e0e0; margin: 25px 0;'>", unsafe_allow_html=True)

            # ç¬¬äºŒéƒ¨åˆ†æ ‡é¢˜
            st.markdown("##### ğŸ”§ æ“ä½œ")

            # ä¸‰ä¸ªåŠŸèƒ½æ¡†ï¼š33%å®½åº¦å¹¶æ’
            col1, col2, col3 = st.columns([1, 1, 1])

            with col1:
                test_model_name = st.text_input(
                    "",
                    placeholder="è¾“å…¥æµ‹è¯•æ¨¡å‹åç§°",
                    key="test_model_name",
                    value=st.session_state['temp_api_config']['test_model_name'],
                    label_visibility="collapsed"
                )

            with col2:
                if st.button("ğŸ§ª æµ‹è¯•APIè¿æ¥", type="secondary", use_container_width=True):
                    # éªŒè¯è¾“å…¥
                    validation_passed = True
                    test_error_messages = []

                    if not provider_name:
                        test_error_messages.append("âŒ ä¾›åº”å•†åç§°ä¸èƒ½ä¸ºç©º")
                        validation_passed = False

                    if not api_key:
                        test_error_messages.append("âŒ APIå¯†é’¥ä¸èƒ½ä¸ºç©º")
                        validation_passed = False

                    if not base_url:
                        test_error_messages.append("âŒ EndPointåœ°å€ä¸èƒ½ä¸ºç©º")
                        validation_passed = False

                    if not selected_full_url:
                        test_error_messages.append("âŒ è¯·é€‰æ‹©å®Œæ•´URLæ ¼å¼")
                        validation_passed = False

                    if not test_model_name:
                        test_error_messages.append("âŒ æµ‹è¯•æ¨¡å‹åç§°ä¸èƒ½ä¸ºç©º")
                        validation_passed = False

                    if not validation_passed:
                        for msg in test_error_messages:
                            st.error(msg)
                    else:
                        # è¿›è¡Œè¿é€šæ€§æµ‹è¯•
                        with st.spinner("æ­£åœ¨æµ‹è¯•APIè¿é€šæ€§..."):
                            try:
                                import requests
                                import json

                                # æ ¹æ®URLæ ¼å¼ç¡®å®šAPIç±»å‹
                                if "/chat/completions" in selected_full_url:
                                    # OpenAIæ ¼å¼
                                    payload = {
                                        "model": test_model_name.strip(),
                                        "messages": [{"role": "user", "content": "Hi"}],
                                        "max_tokens": 5
                                    }
                                elif "/messages" in selected_full_url:
                                    # Anthropicæ ¼å¼
                                    payload = {
                                        "model": test_model_name.strip(),
                                        "max_tokens": 5,
                                        "messages": [{"role": "user", "content": "Hi"}]
                                    }
                                elif "/generateContent" in selected_full_url:
                                    # Geminiæ ¼å¼
                                    payload = {
                                        "contents": [{
                                            "parts": [{"text": "Hi"}]
                                        }],
                                        "generationConfig": {
                                            "maxOutputTokens": 5
                                        }
                                    }
                                else:
                                    # é»˜è®¤ä½¿ç”¨OpenAIæ ¼å¼
                                    payload = {
                                        "model": test_model_name.strip(),
                                        "messages": [{"role": "user", "content": "Hi"}],
                                        "max_tokens": 5
                                    }

                                headers = {
                                    "Content-Type": "application/json",
                                    "Authorization": f"Bearer {api_key.strip()}"
                                }

                                # å‘é€HTTPè¯·æ±‚
                                response = requests.post(
                                    selected_full_url.strip(),
                                    headers=headers,
                                    data=json.dumps(payload),
                                    timeout=10
                                )

                                # æ£€æŸ¥å“åº”
                                if response.status_code == 200:
                                    st.success(f"âœ… APIè¿æ¥æµ‹è¯•æˆåŠŸï¼çŠ¶æ€ç : {response.status_code}")
                                    try:
                                        resp_json = response.json()
                                        if "choices" in resp_json:
                                            content = resp_json["choices"][0]["message"]["content"]
                                        elif "content" in resp_json:
                                            content = resp_json["content"][0]["text"]
                                        elif "candidates" in resp_json:
                                            content = resp_json["candidates"][0]["content"]["parts"][0]["text"]
                                        else:
                                            content = str(resp_json)[:100]
                                        st.info(f"å“åº”é¢„è§ˆ: {content[:100]}...")
                                    except:
                                        pass
                                elif response.status_code == 401:
                                    st.error(f"âŒ è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIå¯†é’¥ã€‚çŠ¶æ€ç : {response.status_code}")
                                elif response.status_code == 404:
                                    st.error(f"âŒ APIç«¯ç‚¹ä¸å­˜åœ¨æˆ–æ¨¡å‹åç§°é”™è¯¯ã€‚çŠ¶æ€ç : {response.status_code}")
                                else:
                                    st.warning(f"âš ï¸ APIå“åº”å¼‚å¸¸ã€‚çŠ¶æ€ç : {response.status_code}")
                                    try:
                                        error_data = response.json()
                                        st.error(f"é”™è¯¯ä¿¡æ¯: {error_data}")
                                    except:
                                        st.error(f"å“åº”å†…å®¹: {response.text[:200]}")
                            except requests.exceptions.Timeout:
                                st.error("âŒ è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç«¯ç‚¹åœ°å€")
                            except requests.exceptions.ConnectionError:
                                st.error("âŒ è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥EndPointåœ°å€æ˜¯å¦æ­£ç¡®")
                            except Exception as e:
                                st.error(f"âŒ æµ‹è¯•è¿æ¥å¤±è´¥: {str(e)}")

            with col3:
                save_btn = st.button("ğŸ’¾ ä¿å­˜APIå¯†é’¥", type="primary", use_container_width=True)

            # å¤„ç†ä¿å­˜æŒ‰é’®
            if save_btn:
                if not provider_name:
                    st.error("âŒ ä¾›åº”å•†åç§°ä¸èƒ½ä¸ºç©º")
                elif not api_key:
                    st.error("âŒ APIå¯†é’¥ä¸èƒ½ä¸ºç©º")
                elif not base_url:
                    st.error("âŒ APIç«¯ç‚¹ä¸èƒ½ä¸ºç©º")
                else:
                    try:
                        secrets_manager = get_secrets_manager()
                        secret_id = secrets_manager.add_api_secret(
                            provider=provider_name.strip(),
                            api_key=api_key.strip(),
                            base_url=base_url.strip(),
                            tag=tag.strip() if tag else ""
                        )
                        st.success(
                            f"âœ… å·²æ·»åŠ APIå¯†é’¥ç»„åˆï¼\n"
                            f"ID: {secret_id} | TAG: {tag if tag else '(æ— æ ‡ç­¾)'}"
                        )
                        # æ¸…ç©ºä¸´æ—¶æ•°æ®
                        st.session_state['temp_api_config'] = {
                            'provider_name': '',
                            'tag': '',
                            'test_model_name': '',
                            'api_key': '',
                            'base_url': ''
                        }
                        st.rerun()
                    except Exception as e:
                        st.error(f"âŒ ä¿å­˜å¤±è´¥: {e}")

            # ä¿å­˜ä¸´æ—¶æ•°æ®åˆ°session_state
            st.session_state['temp_api_config']['provider_name'] = provider_name
            st.session_state['temp_api_config']['tag'] = tag
            st.session_state['temp_api_config']['test_model_name'] = test_model_name
            st.session_state['temp_api_config']['api_key'] = api_key
            st.session_state['temp_api_config']['base_url'] = base_url
            st.session_state['temp_api_config']['selected_full_url'] = selected_full_url

            st.markdown("---")

            # ==================== APIå¯†é’¥ç®¡ç† ====================
            st.markdown("#### APIå¯†é’¥ç®¡ç†")

            secrets_manager = get_secrets_manager()

            # è·å–æ‰€æœ‰APIå¯†é’¥å’Œç«¯ç‚¹ç»„åˆ
            all_secrets = secrets_manager.get_api_secrets()

            # å­æ¨¡å—1ï¼šå½“å‰é…ç½®åˆ—è¡¨
            st.markdown("##### å½“å‰é…ç½®")

            if not all_secrets:
                st.info("ğŸ“­ æš‚æ— é…ç½®ï¼Œè¯·æ·»åŠ APIå¯†é’¥ç»„åˆ")
            else:
                # åˆ›å»ºè¡¨æ ¼å±•ç¤º
                for secret in all_secrets:
                    provider = secret['provider']
                    tag = secret['tag'] if secret['tag'] else "(æ— æ ‡ç­¾)"
                    # åŠ å¯†æ˜¾ç¤ºAPI-KEYï¼Œå‰4ä½ + **** + å4ä½
                    key_preview = f"{secret['api_key'][:4]}****{secret['api_key'][-4:]}" if len(secret['api_key']) >= 8 else "****"
                    endpoint = secret['base_url'] if secret['base_url'] else "(æ— ç«¯ç‚¹)"

                    st.markdown(
                        f"**{provider}** | **{tag}** | **{key_preview}** | **{endpoint}**"
                    )

            st.markdown("---")

            # å­æ¨¡å—2ï¼šåˆ é™¤APIå¯†é’¥
            st.markdown("##### åˆ é™¤APIå¯†é’¥")

            if not all_secrets:
                st.info("æš‚æ— é…ç½®å¯åˆ é™¤")
            else:
                # åˆ›å»ºåˆ é™¤é€‰é¡¹ - åªæ˜¾ç¤ºæ ‡ç­¾å’Œä¾›åº”å•†
                secret_options = {}
                for secret in all_secrets:
                    tag_display = secret['tag'] if secret['tag'] else "(æ— æ ‡ç­¾)"
                    option_text = f"[{secret['provider']}] {tag_display}"
                    secret_options[option_text] = secret['id']

                col1, col2 = st.columns([2, 1])

                with col1:
                    selected_option = st.selectbox(
                        "",
                        options=list(secret_options.keys()),
                        label_visibility="collapsed",
                        placeholder="é€‰æ‹©è¦åˆ é™¤çš„APIå¯†é’¥"
                    )

                with col2:
                    if st.button("ğŸ—‘ï¸ åˆ é™¤", type="secondary", use_container_width=True):
                        selected_id = secret_options[selected_option]
                        st.session_state['secret_to_delete'] = {
                            'id': selected_id,
                            'option': selected_option
                        }

                # ç¡®è®¤åˆ é™¤å¯¹è¯æ¡†
                if 'secret_to_delete' in st.session_state:
                    secret_info = st.session_state['secret_to_delete']
                    st.warning(
                        f"âš ï¸ ç¡®è®¤è¦åˆ é™¤APIå¯†é’¥å—ï¼Ÿ\n\n{secret_info['option']}\n\n"
                        f"æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼"
                    )

                    col3, col4 = st.columns(2)
                    with col3:
                        if st.button("âœ… ç¡®è®¤åˆ é™¤", type="primary"):
                            try:
                                success = secrets_manager.delete_api_secret_by_id(
                                    secret_info['id']
                                )
                                if success:
                                    st.success("âœ… APIå¯†é’¥å·²åˆ é™¤ï¼")
                                    del st.session_state['secret_to_delete']
                                    st.rerun()
                                else:
                                    st.error("âŒ åˆ é™¤å¤±è´¥ï¼ŒAPIå¯†é’¥å¯èƒ½å·²è¢«åˆ é™¤")
                                    del st.session_state['secret_to_delete']
                            except Exception as e:
                                st.error(f"âŒ åˆ é™¤å¤±è´¥: {e}")
                                del st.session_state['secret_to_delete']

                    with col4:
                        if st.button("âŒ å–æ¶ˆ"):
                            del st.session_state['secret_to_delete']
                            st.rerun()

        except Exception as e:
            st.error(f"åŠ è½½APIå¯†é’¥çŠ¶æ€å¤±è´¥: {e}")

    with tab2:
        st.subheader("ğŸ¤– æ¨¡å‹é…ç½®")

        try:
            from ai_researcher.models.config_manager import ModelConfigManager
            from ai_researcher.secrets_manager import get_secrets_manager

            manager = ModelConfigManager()
            secrets_manager = get_secrets_manager()

            # è·å–æ‰€æœ‰æä¾›å•†å’Œç«¯ç‚¹
            providers = secrets_manager.get_all_providers()
            base_urls = secrets_manager.get_all_base_urls()

            # ==================== æ·»åŠ æ¨¡å‹é…ç½® ====================
            st.markdown("â• æ·»åŠ æ¨¡å‹é…ç½®")

            # è¡¨å•å¤–çš„æµ‹è¯•æŒ‰é’®
            test_model_btn = st.button(
                "ğŸ§ª æµ‹è¯•æ¨¡å‹è¿æ¥",
                type="secondary",
                use_container_width=True
            )

            with st.form("add_model_config"):
                # åŸºæœ¬é…ç½®
                st.markdown("**åŸºæœ¬é…ç½®**")
                col1, col2 = st.columns(2)

                with col1:
                    config_name = st.text_input("é…ç½®åç§°", placeholder="ä¾‹å¦‚ï¼šMy-GPT4", key="test_config_name")
                    provider = st.selectbox(
                        "æä¾›å•†",
                        options=sorted(providers) if providers else ["æ— å¯ç”¨æä¾›å•†"],
                        key="test_provider"
                    )

                with col2:
                    model_name = st.text_input("æ¨¡å‹åç§°", placeholder="ä¾‹å¦‚ï¼šgpt-4, claude-3, gemini-pro", key="model_name_config")
                    api_type = st.selectbox(
                        "APIç±»å‹",
                        options=[
                            "chat",
                            "messages",
                            "generateContent",
                            "response",
                            "reasoning",
                            "new_api"
                        ],
                        index=0,
                        format_func=lambda x: {
                            "chat": "Chat Completions (OpenAIå…¼å®¹)",
                            "messages": "Messages (Anthropicå…¼å®¹)",
                            "generateContent": "GenerateContent (GeminiåŸç”Ÿ)",
                            "response": "Response (é€šç”¨)",
                            "reasoning": "Reasoning (æ¨ç†æ¨¡å‹)",
                            "new_api": "NEW-API (APIä»£ç†ï¼Œå…¼å®¹ä¸‰ç§æ ¼å¼)"
                        }.get(x, x),
                        key="test_api_type"
                    )

                # ç«¯ç‚¹é…ç½®
                if api_type == "new_api":
                    st.info("ğŸ’¡ NEW-API è¯´æ˜", icon="â„¹ï¸")
                    st.write("NEW-API æ˜¯ä¸€ä¸ªAPIä»£ç†ï¼Œé€šè¿‡åŸºç¡€URLå…¼å®¹ä¸‰ç§æ ¼å¼ï¼š")
                    st.write("â€¢ å«gpt/openai â†’ è¡¥å…¨ â†’ https://xxx.com/v1/chat/completions")
                    st.write("â€¢ å«claude/anthropic â†’ è¡¥å…¨ â†’ https://xxx.com/v1/messages")
                    st.write("â€¢ å«gemini/google â†’ è¡¥å…¨ â†’ https://xxx.com/v1/generateContent")
                    st.write("åªéœ€è¾“å…¥åŸºç¡€URLï¼Œå¦‚ï¼šhttps://api.example.com")

                if providers and base_urls:
                    selected_endpoint = st.selectbox(
                        "é€‰æ‹©å·²é…ç½®çš„ç«¯ç‚¹",
                        options=sorted(base_urls.keys()) if base_urls else ["æ— å¯ç”¨ç«¯ç‚¹"],
                        key="test_selected_endpoint"
                    )

                    if selected_endpoint and selected_endpoint != "æ— å¯ç”¨ç«¯ç‚¹":
                        base_url_value = base_urls[selected_endpoint]
                        # å¦‚æœæ˜¯NEW-APIç±»å‹ï¼Œæ˜¾ç¤ºå®Œæ•´çš„URLé¢„è§ˆ
                        if api_type == "new_api":
                            from ai_researcher.models.api_client import UnifiedAPIClient
                            full_url = UnifiedAPIClient.get_full_url_preview(base_url_value, api_type, model_name)
                            if model_name:
                                st.success(f"ğŸ’¡ å®Œæ•´URL: {full_url}")
                        else:
                            st.info(f"ç«¯ç‚¹URL: {base_url_value}")
                else:
                    selected_endpoint = st.text_input(
                        "æˆ–ç›´æ¥è¾“å…¥ç«¯ç‚¹URL",
                        placeholder="https://api.example.com" if api_type == "new_api" else "https://...",
                        key="test_selected_endpoint"
                    )

                # APIå¯†é’¥é€‰æ‹©
                # è·å–æ‰€æœ‰APIå¯†é’¥å’Œç«¯ç‚¹ç»„åˆ
                all_secrets = secrets_manager.get_api_secrets()

                # æ ¹æ®é€‰ä¸­çš„æä¾›å•†è¿‡æ»¤ç»„åˆ
                available_secrets = [s for s in all_secrets if s['provider'] == provider] if provider != "æ— å¯ç”¨æä¾›å•†" else []

                if available_secrets:
                    # åˆ›å»ºä¸‹æ‹‰é€‰é¡¹ï¼šæ˜¾ç¤º TAG | API-KEY | ç«¯ç‚¹
                    secret_options = {}
                    for secret in available_secrets:
                        tag = secret['tag'] if secret['tag'] else "(æ— æ ‡ç­¾)"
                        key_preview = f"{secret['api_key'][:8]}...{secret['api_key'][-4:]}"
                        endpoint = secret['base_url'] if secret['base_url'] else "(æ— ç«¯ç‚¹)"
                        option_text = f"{tag} | {key_preview} | {endpoint}"
                        secret_options[option_text] = secret['id']

                    selected_secret = st.selectbox(
                        "é€‰æ‹©APIå¯†é’¥å’Œç«¯ç‚¹ç»„åˆ",
                        options=list(secret_options.keys()),
                        key="test_api_secret_selector"
                    )
                    selected_secret_id = secret_options[selected_secret]
                else:
                    st.warning(f"âš ï¸ æœªæ‰¾åˆ° '{provider}' çš„APIå¯†é’¥ç»„åˆï¼Œè¯·å…ˆåœ¨APIå¯†é’¥ç®¡ç†ä¸­æ·»åŠ ")
                    selected_secret_id = None

                # ä»£ç†è®¾ç½®
                st.markdown("**ç½‘ç»œè®¾ç½®**")
                col_proxy1, col_proxy2 = st.columns([2, 1])

                with col_proxy1:
                    use_proxy = st.checkbox(
                        "é€šè¿‡HTTPä»£ç†è®¿é—®",
                        value=False,
                        key="test_use_proxy"
                    )

                if use_proxy:
                    import os
                    proxy_url = os.environ.get('HTTP_PROXY', '')
                    if proxy_url:
                        st.success(f"âœ… ä»£ç†å·²é…ç½®: {proxy_url}")
                    else:
                        st.warning("âš ï¸ HTTP_PROXYç¯å¢ƒå˜é‡æœªè®¾ç½®ï¼Œè¯·ç¡®ä¿åœ¨docker-compose.ymlä¸­é…ç½®")

                # å‚æ•°è®¾ç½®ï¼ˆåœ¨è¡¨å•å†…éƒ¨ï¼‰
                st.markdown("**å‚æ•°è®¾ç½®**")
                col1, col2 = st.columns(2)
                with col1:
                    temperature = st.slider("æ¸©åº¦å‚æ•°", min_value=0.0, max_value=1.0, value=0.7, step=0.1, key="test_temperature")
                with col2:
                    max_tokens = st.number_input("æœ€å¤§Tokenæ•°", min_value=100, max_value=32000, value=4000, step=100, key="test_max_tokens")

                # æ¿€æ´»é€‰é¡¹
                is_active = st.checkbox("ç«‹å³æ¿€æ´»æ­¤é…ç½®", value=True, key="test_is_active")

                # æ·»åŠ é…ç½®æŒ‰é’®ï¼ˆåœ¨è¡¨å•å†…éƒ¨ï¼‰
                submitted = st.form_submit_button("ğŸ’¾ æ·»åŠ é…ç½®", type="primary")

            # å¤„ç†è¡¨å•æäº¤ï¼ˆåœ¨è¡¨å•å†…éƒ¨ï¼‰
            if submitted:
                # éªŒè¯è¾“å…¥
                validation_passed = True

                if not config_name.strip():
                    st.error("âŒ é…ç½®åç§°ä¸èƒ½ä¸ºç©º")
                    validation_passed = False

                if not model_name.strip():
                    st.error("âŒ æ¨¡å‹åç§°ä¸èƒ½ä¸ºç©º")
                    validation_passed = False

                # æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†APIå¯†é’¥ç»„åˆ
                if not selected_secret_id:
                    st.error("âŒ è¯·å…ˆé€‰æ‹©APIå¯†é’¥å’Œç«¯ç‚¹ç»„åˆ")
                    validation_passed = False

                if not validation_passed:
                    st.stop()

                try:
                    # ä½¿ç”¨é€‰æ‹©çš„APIå¯†é’¥ç»„åˆID
                    api_secret_id_value = selected_secret_id

                    # è·å–å®Œæ•´çš„APIå¯†é’¥ç»„åˆä¿¡æ¯
                    secret_info = secrets_manager.get_api_secret_by_id(selected_secret_id)
                    if not secret_info:
                        st.error("âŒ æ— æ³•è·å–APIå¯†é’¥ç»„åˆä¿¡æ¯")
                        st.stop()

                    # å¦‚æœæ˜¯NEW-APIç±»å‹ï¼Œæ˜¾ç¤ºå®Œæ•´URLé¢„è§ˆ
                    if api_type == "new_api":
                        from ai_researcher.models.api_client import UnifiedAPIClient
                        full_url = UnifiedAPIClient.get_full_url_preview(
                            secret_info['base_url'], api_type, model_name
                        )
                        st.success(f"âœ… NEW-APIå®Œæ•´URL: {full_url}", icon="âœ…")

                    success = manager.add_model_config(
                        name=config_name,
                        provider=provider,
                        endpoint=secret_info['base_url'],
                        api_type=api_type,
                        api_key=secret_info['api_key'],
                        api_secret_id=api_secret_id_value,
                        model_name=model_name,
                        temperature=temperature,
                        max_tokens=max_tokens,
                        use_proxy=use_proxy,
                        is_active=is_active
                    )

                    if success:
                        st.session_state['config_saved'] = True
                        st.session_state['config_name'] = config_name
                    else:
                        st.error("âŒ æ·»åŠ é…ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®æ˜¯å¦å·²å­˜åœ¨")
                except Exception as e:
                    st.error(f"âŒ æ·»åŠ é…ç½®å¤±è´¥: {e}")

        # æ¨¡å‹è¿é€šæ€§æµ‹è¯•æŒ‰é’®ï¼ˆåœ¨è¡¨å•å¤–éƒ¨ï¼Œç´§æŒ¨ç€ç½‘ç»œè®¾ç½®ï¼‰
        col_test, col_space = st.columns([1, 3])
        with col_test:
            if st.button("ğŸ” æ¨¡å‹è¿é€šæ€§æµ‹è¯•", type="secondary", use_container_width=True):
                # è·å–è¡¨å•å¤–çš„å€¼
                test_config_name = st.session_state.get('test_config_name', '')
                test_provider = st.session_state.get('test_provider', '')
                test_model_name = st.session_state.get('model_name_config', '')
                test_selected_endpoint = st.session_state.get('test_selected_endpoint', '')
                test_api_type = st.session_state.get('test_api_type', 'chat')
                test_selected_secret = st.session_state.get('test_api_secret_selector', '')

                # éªŒè¯è¾“å…¥
                validation_passed = True
                test_error_messages = []

                if not test_config_name.strip():
                    test_error_messages.append("âŒ é…ç½®åç§°ä¸èƒ½ä¸ºç©º")
                    validation_passed = False

                if not test_model_name.strip():
                    test_error_messages.append("âŒ æ¨¡å‹åç§°ä¸èƒ½ä¸ºç©º")
                    validation_passed = False

                if not test_provider or test_provider == "æ— å¯ç”¨æä¾›å•†":
                    test_error_messages.append("âŒ è¯·é€‰æ‹©æä¾›å•†")
                    validation_passed = False

                if not test_selected_endpoint or test_selected_endpoint == "æ— å¯ç”¨ç«¯ç‚¹":
                    test_error_messages.append("âŒ è¯·é€‰æ‹©æˆ–è¾“å…¥ç«¯ç‚¹URL")
                    validation_passed = False

                if not test_selected_secret:
                    test_error_messages.append("âŒ è¯·é€‰æ‹©APIå¯†é’¥ç»„åˆ")
                    validation_passed = False

                if not validation_passed:
                    for msg in test_error_messages:
                        st.error(msg)
                else:
                    # è¿›è¡Œè¿æ¥æµ‹è¯•
                    with st.spinner("æ­£åœ¨æµ‹è¯•æ¨¡å‹è¿æ¥..."):
                        try:
                            # è·å–ç«¯ç‚¹URL
                            if test_selected_endpoint and test_selected_endpoint != "æ— å¯ç”¨ç«¯ç‚¹" and test_selected_endpoint in base_urls:
                                test_endpoint = base_urls[test_selected_endpoint]
                            else:
                                test_endpoint = test_selected_endpoint

                            # å¦‚æœæ˜¯NEW-APIç±»å‹ï¼Œç”Ÿæˆå®Œæ•´URLé¢„è§ˆ
                            if test_api_type == "new_api":
                                from ai_researcher.models.api_client import UnifiedAPIClient
                                full_url = UnifiedAPIClient.get_full_url_preview(test_endpoint, test_api_type, test_model_name)
                                test_endpoint_for_api = full_url
                            else:
                                test_endpoint_for_api = test_endpoint

                            # è·å–APIå¯†é’¥
                            all_secrets = secrets_manager.get_api_secrets()
                            selected_secret_id = None
                            for secret in all_secrets:
                                tag = secret['tag'] if secret['tag'] else "(æ— æ ‡ç­¾)"
                                key_preview = f"{secret['api_key'][:8]}...{secret['api_key'][-4:]}"
                                endpoint = secret['base_url'] if secret['base_url'] else "(æ— ç«¯ç‚¹)"
                                option_text = f"{tag} | {key_preview} | {endpoint}"
                                if option_text == test_selected_secret:
                                    selected_secret_id = secret['id']
                                    break

                            if not selected_secret_id:
                                st.error("âŒ æ— æ³•è·å–APIå¯†é’¥ID")
                                st.stop()

                            secret_info = secrets_manager.get_api_secret_by_id(selected_secret_id)
                            if not secret_info:
                                st.error("âŒ æ— æ³•è·å–APIå¯†é’¥ä¿¡æ¯")
                                st.stop()

                            # è°ƒç”¨æµ‹è¯•è¿æ¥
                            test_result = secrets_manager.test_api_connection(
                                provider=test_provider,
                                api_key=secret_info['api_key'].strip(),
                                base_url=test_endpoint_for_api,
                                test_model=test_model_name.strip()
                            )

                            # æ˜¾ç¤ºæµ‹è¯•ç»“æœ
                            if test_result["success"]:
                                st.success(test_result["message"])
                                if "response_preview" in test_result:
                                    st.info(f"å“åº”é¢„è§ˆ: {test_result['response_preview'][:100]}...")
                            else:
                                st.error(test_result["message"])
                                if "error" in test_result:
                                    st.error(f"é”™è¯¯è¯¦æƒ…: {test_result['error']}")
                        except Exception as e:
                            st.error(f"âŒ æµ‹è¯•è¿æ¥å¤±è´¥: {str(e)}")

        # æ˜¾ç¤ºä¿å­˜æˆåŠŸçš„æç¤º
        if st.session_state.get('config_saved', False):
            st.success(f"âœ… é…ç½® '{st.session_state.get('config_name', '')}' æ·»åŠ æˆåŠŸï¼")
            # æ¸…é™¤çŠ¶æ€
            del st.session_state['config_saved']
            if 'config_name' in st.session_state:
                del st.session_state['config_name']

        st.markdown("---")

        # ==================== é…ç½®åˆ—è¡¨ ====================
        st.markdown("ğŸ“‹ å½“å‰é…ç½®")

        configs = manager.list_model_configs()

        if not configs:
            st.info("ğŸ“­ æš‚æ— æ¨¡å‹é…ç½®")
        else:
            for config in configs:
                with st.container():
                    col1, col2, col3, col4 = st.columns([3, 1, 1, 1])

                    with col1:
                        status = "âœ… æ¿€æ´»" if config.get('is_active') else "â—‹ æœªæ¿€æ´»"
                        st.markdown(f"**{config['name']}** {status}")
                        st.write(f"{config['provider']} - {config['model_name']}")

                    with col2:
                        if st.button("ğŸ‘ï¸ æŸ¥çœ‹", key=f"view_{config['name']}"):
                            st.session_state[f'view_config_{config["name"]}'] = True

                    with col3:
                        if st.button("ğŸ§ª æµ‹è¯•", key=f"test_{config['name']}"):
                            st.session_state[f'test_config_{config["name"]}'] = True

                    with col4:
                        if st.button("ğŸ—‘ï¸ åˆ é™¤", key=f"delete_{config['name']}"):
                            st.session_state[f'delete_config_{config["name"]}'] = True

                    # æŸ¥çœ‹è¯¦æƒ…
                    if st.session_state.get(f'view_config_{config["name"]}', False):
                        st.markdown("---")
                        st.json(config)
                        if st.button("âœ… å…³é—­", key=f"close_view_{config['name']}"):
                            st.session_state[f'view_config_{config["name"]}'] = False
                            st.rerun()

                    # æµ‹è¯•è¿æ¥
                    if st.session_state.get(f'test_config_{config["name"]}', False):
                        st.markdown("---")
                        with st.spinner("æ­£åœ¨æµ‹è¯•è¿æ¥..."):
                            try:
                                result = manager.test_connection(config['name'])
                                if result['success']:
                                    st.success("âœ… è¿æ¥æµ‹è¯•æˆåŠŸ")
                                else:
                                    st.error(f"âŒ è¿æ¥æµ‹è¯•å¤±è´¥: {result.get('error', 'æœªçŸ¥é”™è¯¯')}")
                            except Exception as e:
                                st.error(f"æµ‹è¯•è¿æ¥å¤±è´¥: {e}")

                        if st.button("âœ… å…³é—­", key=f'close_test_{config["name"]}'):
                            st.session_state[f'test_config_{config["name"]}'] = False
                            st.rerun()

                    # åˆ é™¤ç¡®è®¤
                    if st.session_state.get(f'delete_config_{config["name"]}', False):
                        st.warning(f"âš ï¸ ç¡®å®šè¦åˆ é™¤é…ç½® '{config['name']}' å—ï¼Ÿ")
                        col_a, col_b = st.columns(2)

                        with col_a:
                            if st.button("âœ… ç¡®è®¤åˆ é™¤", key=f"confirm_delete_{config['name']}"):
                                try:
                                    success = manager.delete_model_config(config['name'])
                                    if success:
                                        st.session_state['config_deleted'] = True
                                        st.session_state['config_deleted_name'] = config['name']
                                        st.session_state[f'delete_config_{config["name"]}'] = False
                                        st.rerun()
                                    else:
                                        st.error("âŒ åˆ é™¤å¤±è´¥")
                                except Exception as e:
                                    st.error(f"âŒ åˆ é™¤é…ç½®å¤±è´¥: {e}")

                        with col_b:
                            if st.button("âŒ å–æ¶ˆ", key=f"cancel_delete_{config['name']}"):
                                st.session_state[f'delete_config_{config["name"]}'] = False
                                st.rerun()

        # æ˜¾ç¤ºåˆ é™¤æˆåŠŸçš„æç¤º
        if st.session_state.get('config_deleted', False):
            config_name = st.session_state.get('config_deleted_name', '')
            st.success(f"âœ… é…ç½® '{config_name}' å·²åˆ é™¤ï¼")
            del st.session_state['config_deleted']
            del st.session_state['config_deleted_name']

        st.markdown("---")

    except Exception as e:
        st.error(f"åŠ è½½æ¨¡å‹é…ç½®å¤±è´¥: {e}")

    with tab3:
        st.subheader("âš™ï¸ ç³»ç»Ÿé…ç½®")

        # RAGFlowé…ç½®
        st.markdown("### ğŸ“š RAGFlowçŸ¥è¯†åº“é…ç½®")

        try:
            from ai_researcher.config import load_config, save_config
            from ai_researcher.core.ragflow import RAGFlowClient, RAGFlowError
            config = load_config()

            # å½“å‰é…ç½®
            current_config = config.get('ragflow', {})
            current_endpoint = current_config.get('endpoint', 'http://192.168.3.147:20334')
            current_api_key = current_config.get('api_key', '')
            current_ports = current_config.get('ports', {})

            # ç«¯å£é…ç½®å­—å…¸
            port_defaults = {
                'SVR_WEB_HTTP_PORT': 20334,
                'SVR_WEB_HTTPS_PORT': 443,
                'SVR_HTTP_PORT': 20335,
                'ADMIN_SVR_HTTP_PORT': 20336,
                'SVR_MCP_PORT': 20337,
            }

            st.info("â„¹ï¸ RAGFlow Dockerç«¯å£æ˜ å°„é…ç½®", icon="â„¹ï¸")

            with st.form("ragflow_config_form"):
                col1, col2 = st.columns([2, 1])

                with col1:
                    endpoint = st.text_input(
                        "RAGFlowæœåŠ¡ç«¯ç‚¹",
                        value=current_endpoint
                    )

                with col2:
                    api_key = st.text_input(
                        "RAGFlow APIå¯†é’¥",
                        value=current_api_key,
                        type="password"
                    )

                st.markdown("**ç«¯å£æ˜ å°„é…ç½®**")
                ports_cols = st.columns(3)
                ports_data = {}

                port_items = list(port_defaults.items())
                for idx, (port_name, default_val) in enumerate(port_items):
                    col = ports_cols[idx % 3]
                    with col:
                        ports_data[port_name] = st.number_input(
                            port_name,
                            value=current_ports.get(port_name, default_val),
                            min_value=1,
                            max_value=65535
                        )

                submitted = st.form_submit_button(
                    "ğŸ’¾ ä¿å­˜é…ç½®",
                    type="primary",
                    use_container_width=True
                )

                if submitted:
                    try:
                        config['ragflow'] = {
                            'endpoint': endpoint.strip(),
                            'api_key': api_key.strip(),
                            'ports': {k: int(v) for k, v in ports_data.items()}
                        }

                        if save_config(config):
                            st.success("âœ… RAGFlowé…ç½®å·²ä¿å­˜")
                            st.rerun()
                        else:
                            st.error("âŒ ä¿å­˜å¤±è´¥")
                    except Exception as e:
                        st.error(f"âŒ ä¿å­˜å¤±è´¥: {e}")

            # å¿«é€Ÿæ“ä½œ
            col1, col2 = st.columns(2)

            with col1:
                if st.button("ğŸ” æµ‹è¯•è¿æ¥", use_container_width=True):
                    try:
                        client = RAGFlowClient(
                            endpoint=current_endpoint,
                            api_key=current_api_key,
                            ports=current_ports
                        )
                        health = client.health_check()
                        if health:
                            st.success("âœ… RAGFlowè¿æ¥æˆåŠŸ")
                        else:
                            st.warning("âš ï¸ RAGFlowæœåŠ¡æœªå“åº”")
                    except Exception as e:
                        st.error(f"âŒ è¿æ¥å¤±è´¥: {str(e)[:100]}")

            with col2:
                if st.button("ğŸ”„ é‡ç½®ä¸ºé»˜è®¤", use_container_width=True):
                    try:
                        config['ragflow'] = {
                            'endpoint': 'http://192.168.3.147:20334',
                            'api_key': '',
                            'ports': port_defaults
                        }
                        if save_config(config):
                            st.success("âœ… å·²é‡ç½®ä¸ºé»˜è®¤é…ç½®")
                            st.rerun()
                    except Exception as e:
                        st.error(f"âŒ é‡ç½®å¤±è´¥: {e}")

            # æ˜¾ç¤ºå½“å‰é…ç½®çŠ¶æ€
            st.markdown("---")
            st.markdown("**å½“å‰é…ç½®**")
            if current_endpoint:
                st.write(f"ç«¯ç‚¹: {current_endpoint}")
            if current_api_key:
                st.write("APIå¯†é’¥: âœ… å·²é…ç½®")
            else:
                st.write("APIå¯†é’¥: âŒ æœªé…ç½®")

            st.markdown("**ç«¯å£é…ç½®**")
            for port_name, port_value in (current_ports or port_defaults).items():
                st.write(f"{port_name}: {port_value}")

        except Exception as e:
            st.error(f"åŠ è½½é…ç½®å¤±è´¥: {e}")

        # æ•°æ®åº“é…ç½®
        st.markdown("---")
        st.markdown("### ğŸ’¾ æ•°æ®åº“é…ç½®")

        try:
            import os
            db_path = os.environ.get('DATABASE_PATH', '/app/data/experiments/experiments.db')

            st.info(f"å½“å‰æ•°æ®åº“è·¯å¾„: {db_path}")

            col1, col2 = st.columns(2)

            with col1:
                if st.button("ğŸ“Š æŸ¥çœ‹æ•°æ®åº“çŠ¶æ€"):
                    try:
                        from ai_researcher.experiments.manager import ExperimentManager
                        exp_manager = ExperimentManager(db_path)
                        experiments = exp_manager.list_experiments()
                        st.success(f"âœ… æ•°æ®åº“æ­£å¸¸ï¼Œå…± {len(experiments)} ä¸ªå®éªŒ")
                    except Exception as e:
                        st.error(f"âŒ æ•°æ®åº“å¼‚å¸¸: {e}")

            with col2:
                if st.button("ğŸ—ƒï¸ åˆå§‹åŒ–æ•°æ®åº“"):
                    try:
                        from ai_researcher.experiments.manager import ExperimentManager
                        exp_manager = ExperimentManager(db_path)
                        st.success("âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ")
                    except Exception as e:
                        st.error(f"âŒ åˆå§‹åŒ–å¤±è´¥: {e}")

        except Exception as e:
            st.error(f"æ•°æ®åº“æ“ä½œå¤±è´¥: {e}")

        # ç³»ç»Ÿä¿¡æ¯
        st.markdown("---")
        st.markdown("### â„¹ï¸ ç³»ç»Ÿä¿¡æ¯")

        sys_info = {
            "Pythonç‰ˆæœ¬": sys.version.split()[0],
            "Streamlitç‰ˆæœ¬": st.__version__,
        }

        for key, value in sys_info.items():
            st.write(f"**{key}**: {value}")


if __name__ == "__main__":
    run()
